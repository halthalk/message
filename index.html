<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø§ÙƒØ§Ø© Telegram Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†Ø© (Ù…Ù„ÙØ§Øª ØµÙˆØªÙŠØ© Ù…ÙØ¹Ø¯Ù„Ø©)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ğŸ¨ ØªØµÙ…ÙŠÙ… Telegram Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙˆØ§Ù„Ù…Ø­Ø³Ù† */
        :root {
            --telegram-blue: #229ED9;
            --telegram-dark-blue: #1D7AFC;
            --background-dark: #1a1f27;
            --text-light: #ffffff;
            --text-secondary: #b8c1d1;
            --input-bg: rgba(255, 255, 255, 0.1);
            --bubble-self-bg: linear-gradient(135deg, var(--telegram-blue), var(--telegram-dark-blue));
            --bubble-other-bg: rgba(255, 255, 255, 0.15);
        }

        /* --- Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ù… ØªØªØºÙŠØ±) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, var(--background-dark) 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }
        .popup {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }
        .popup-content {
            background: linear-gradient(180deg, #0f1419 0%, var(--background-dark) 100%);
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 420px;
            height: 90%;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            border: 1px solid #2a2f3a;
        }
        .header {
            background: linear-gradient(90deg, var(--telegram-blue) 0%, var(--telegram-dark-blue) 100%);
            color: white;
            padding: 18px;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .chat-list {
            list-style: none;
            height: calc(100% - 70px);
            overflow-y: auto;
            padding: 10px 0;
        }
        .chat-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .chat-item:hover, .chat-item.active {
            background: rgba(34, 158, 217, 0.2);
            border-right: 4px solid var(--telegram-blue);
        }
        .avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            margin-left: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            font-weight: bold;
            background: var(--bubble-self-bg);
            box-shadow: 0 4px 12px rgba(34, 158, 217, 0.3);
            flex-shrink: 0;
        }
        .chat-info {
            flex: 1;
            min-width: 0;
        }
        .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .last-message {
            color: var(--text-secondary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-messages {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #0f1419 0%, var(--background-dark) 100%);
            z-index: 1001;
            overflow: hidden;
        }
        .messages-header {
            background: linear-gradient(90deg, var(--telegram-blue) 0%, var(--telegram-dark-blue) 100%);
            color: white;
            padding: 18px 20px;
            font-size: 18px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 20;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            margin-left: 10px;
            transition: all 0.2s;
        }
        .message-list {
            padding: 20px;
            height: calc(100% - 110px); 
            overflow-y: auto;
            padding-bottom: 100px;
        }
        .message {
            margin-bottom: 16px;
            display: flex;
            justify-content: flex-end; /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠÙ…ÙŠÙ†) */
            opacity: 0;
            animation: fadeIn 0.3s forwards;
            transform: translateY(10px);
        }
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }
        .message-content {
            background: var(--bubble-self-bg);
            padding: 12px 18px;
            border-radius: 18px 18px 5px 18px;
            max-width: 75%;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(34, 158, 217, 0.3);
            position: relative;
        }
        
        .message-attachment-info {
            display: block;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            margin-top: 5px;
            text-align: right; 
        }
        
        .message.other {
            justify-content: flex-start !important; /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª (ÙŠØ³Ø§Ø±) */
        }
        .message.other .message-content {
            background: var(--bubble-other-bg);
            color: #e8ebee;
            border-radius: 18px 18px 18px 5px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .message.other .message-content .message-attachment-info {
            text-align: left; 
        }

        /* --- Ø£Ù†Ù…Ø§Ø· Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØ±Ø³Ù„Ø© --- */
        .attachment-preview {
            margin-top: 5px;
            /* Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø±ÙÙ‚ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© */
            display: flex;
            flex-direction: column; 
        }
        .attachment-preview img {
            max-width: 100%;
            max-height: 200px;
            display: block;
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        /* â­ï¸ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµÙˆØªÙŠ (Voice Note Style) */
        .attachment-preview .voice-note {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 20px;
            max-width: 100%;
        }
        .attachment-preview .voice-note.other {
            background: rgba(255, 255, 255, 0.1); /* Ø®Ù„ÙÙŠØ© Ø£ÙØªØ­ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª */
        }

        .attachment-preview .voice-play-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--text-light);
            color: var(--telegram-blue);
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            flex-shrink: 0;
            padding: 0;
        }
        .attachment-preview .voice-timeline {
            flex-grow: 1;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 2.5px;
            position: relative;
        }
        .attachment-preview .voice-progress {
            width: 0%;
            height: 100%;
            background: var(--text-light);
            border-radius: 2.5px;
        }
        .attachment-preview .voice-duration {
            font-size: 12px;
            color: var(--text-light);
            flex-shrink: 0;
            width: 35px; /* Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ø±Ø¶ */
            text-align: center;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ù€ <audio> Ø§Ù„Ø£ØµÙ„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© */
        .attachment-preview audio {
            display: none !important;
        }


        .attachment-preview .file-card {
            background: rgba(0, 0, 0, 0.15);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .attachment-preview .file-card-icon {
            font-size: 24px;
            margin-left: 10px;
            color: var(--telegram-blue);
        }
        .attachment-preview .file-card-info {
            flex-grow: 1;
        }
        .attachment-preview .file-card-name {
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .attachment-preview .file-card-size {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .attachment-preview .preview-file-btn {
            background: var(--telegram-dark-blue);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        /* â­ï¸ Ø²Ø± Ø§Ù„Ø­Ø°Ù */
        .delete-btn {
            background: none; 
            border: none; 
            color: #ff5252; /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø®ÙÙŠÙ */
            font-size: 14px; 
            margin-right: 5px; 
            opacity: 0.7; 
            cursor: pointer; 
            transition: opacity 0.2s, transform 0.2s;
            align-self: flex-end; /* Ù„ÙŠÙƒÙˆÙ† ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
            padding: 0;
            line-height: 1;
        }
        .delete-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        /* Ù„Ø¶Ù…Ø§Ù† Ù…Ø­Ø§Ø°Ø§Ø© ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø²Ø± Ø§Ù„Ø­Ø°Ù */
        .message .message-content-wrapper {
            display: flex;
            align-items: flex-end;
        }


        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø­Ø³Ù† */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 31, 39, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 30;
            display: flex;
        }
        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            width: 100%;
        }
        .message-input-area {
            flex: 1;
            display: flex;
            align-items: flex-end;
            background: var(--input-bg);
            border-radius: 25px;
            padding: 8px 16px;
        }
        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            padding: 12px 0;
            outline: none;
            resize: none;
            max-height: 120px; 
            line-height: 1.4;
        }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª */
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
            align-self: center;
            transition: color 0.2s;
        }
        .action-btn:hover {
            color: var(--telegram-blue);
        }
        
        /* Ø²Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ğŸ“) */
        #attachment-btn {
            order: -1; 
            font-size: 25px;
            padding: 0 5px 0 10px;
        }
        
        .send-btn {
            background: var(--bubble-self-bg);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(34, 158, 217, 0.4);
            flex-shrink: 0;
        }
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* --- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª --- */
        #attachment-menu {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: #2a313d;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            padding: 10px;
            display: none;
            z-index: 35;
        }
        .attachment-option {
            padding: 10px;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }
        .attachment-option:hover {
            background: #3c4656;
        }
        .attachment-icon {
            font-size: 20px;
            margin-left: 10px;
            width: 20px;
        }

        /* Ù…Ø¤Ø´Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù„Ù… ÙŠØªØºÙŠØ±) */
        #recording-indicator {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 31, 39, 0.95);
            z-index: 40;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-direction: column;
        }
        .recording-dot {
            width: 10px;
            height: 10px;
            background: red;
            border-radius: 50%;
            animation: pulse 1s infinite;
            margin-bottom: 10px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        #stop-recording-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: var(--telegram-blue);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* --- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Preview Modal) --- */
        #preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1100;
            align-items: center;
            justify-content: center;
        }
        .preview-content {
            background: #1a1f27;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: right;
        }
        .preview-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        /* â­ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
        #preview-media {
            margin-bottom: 15px;
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            display: block;
            margin: 10px auto;
        }
        .preview-caption-input {
            width: 100%;
            background: #2a313d;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            resize: none;
            outline: none;
        }
        .preview-buttons {
            display: flex;
            justify-content: space-between;
        }
        .preview-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        #cancel-preview {
            background: #3c4656;
            color: white;
        }
        #send-preview {
            background: var(--telegram-blue);
            color: white;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(34, 158, 217, 0.5); border-radius: 3px; }
    </style>
</head>
<body>
    <div id="popup" class="popup">
        <div class="popup-content">
            <div class="header">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div> 
            <ul class="chat-list">
                <li class="chat-item active" onclick="showMessages('important', this)">
                    <div class="avatar"><i class="fas fa-bullhorn"></i></div> 
                    <div class="chat-info">
                        <div class="chat-name">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù‡Ø§Ù…Ø©</div>
                        <div class="last-message">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</div>
                    </div>
                </li>
                <li class="chat-item" onclick="showMessages('owner', this)">
                    <div class="avatar"><i class="fas fa-user-tie"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">Ù…Ø§Ù„Ùƒ Ù…Ù†ØµØ© Ø­Ù„ØªÙ‡Ø§Ù„Ùƒ</div>
                        <div class="last-message" id="owner-last-message">ÙØ®ÙˆØ± Ø¨ÙŠÙƒ Ø¬Ø¯Ø§Ù‹ ğŸ¥°</div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <div id="messages" class="chat-messages">
        <div class="messages-header">
            <button class="back-btn" onclick="backToList()">&#8592;</button>
            <span id="chat-title">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span>
        </div>
        
        <div class="message-list" id="message-list"></div>
        
        <div id="recording-indicator">
            <div class="recording-dot"></div>
            <p>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„... <span id="recording-timer">00:00</span></p>
            <button id="stop-recording-btn" onclick="stopRecording()">Ø¥ÙŠÙ‚Ø§Ù ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© <i class="fas fa-square"></i></button>
        </div>

        <div class="input-container" id="message-input-container" style="display: none;">
            <div class="input-wrapper">
                <button class="action-btn" id="attachment-btn" onclick="toggleAttachmentMenu()"><i class="fas fa-paperclip"></i></button>
                <div class="message-input-area">
                    <textarea class="message-input" id="message-input" 
                            placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." 
                            rows="1" 
                            onkeydown="handleKeyPress(event)"></textarea>
                    <button class="action-btn" id="voice-btn" onclick="startRecording()"><i class="fas fa-microphone"></i></button>
                </div>
                <button class="send-btn" id="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
            
            <div id="attachment-menu">
                <label for="image-upload" class="attachment-option">
                    <span class="attachment-icon"><i class="fas fa-image"></i></span> ØµÙˆØ±Ø©
                    <input type="file" id="image-upload" accept="image/*" onchange="handleAttachment(event, 'image')" style="display: none;">
                </label>
                <label for="file-upload" class="attachment-option">
                    <span class="attachment-icon"><i class="fas fa-file"></i></span> Ù…Ù„Ù
                    <input type="file" id="file-upload" accept="*" onchange="handleAttachment(event, 'file')" style="display: none;">
                </label>
            </div>
        </div>
    </div>
    
    <div id="preview-modal">
        <div class="preview-content">
            <div class="preview-header">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø±ÙÙ‚</div>
            <div id="preview-placeholder">
            </div>
            <textarea class="preview-caption-input" id="preview-caption" placeholder="Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..."></textarea>
            <div class="preview-buttons">
                <button id="cancel-preview" onclick="closePreviewModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="send-preview" onclick="sendAttachment()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script>
        // ğŸ’¡ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø«ÙˆØ§Ø¨Øª
        const BOT_TOKEN = '8490684701:AAHUk7Ayn8RmrreRbfVLX41c5nI1EhR3CxE';
        const CHAT_ID = '7428842238';
        const CHAT_STORAGE_KEY = 'telegram_chat_owner';
        
        let currentChat = '';
        let mediaRecorder;
        let audioChunks = [];
        let recorderStartTime;
        let recordingInterval;
        let currentAttachment = null; 

        // Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ ID ÙØ±ÙŠØ¯
        function generateUniqueId() {
            return Date.now() + Math.random().toString(36).substring(2, 9);
        }

        // ğŸ’¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ù…Ø¹ ID Ø«Ø§Ø¨Øª)
        const initialOwnerMessages = [
            { text: 'Ø£Ù†Ø§ ÙØ®ÙˆØ± Ø¨ÙŠÙƒ Ø¬Ø¯Ø§Ù‹ ÙˆØ¨ØªÙ…Ù†Ù‰ Ù„ÙŠÙƒ Ø§Ù„ØªÙÙˆÙ‚ Ø§Ù„Ø¯Ø§Ø¦Ù… â¤', sender: 'bot', id: 'bot1' },
            { text: 'Ù†ØµÙŠØ­ØªÙŠ Ù„ÙŠÙƒ Ø¥Ù†Ùƒ ØªØ³Ø¹Ù‰ ÙˆØ±Ø§ Ø­Ù„Ù…Ùƒ Ù„Ø£Ù† Ø¯Ù‡ Ù…ØµÙŠØ± Ø­ÙŠØ§ØªÙƒ ğŸ©¶', sender: 'bot', id: 'bot2' },
            { text: 'Ø­Ø§ÙˆÙ„ ØªØ·ÙˆØ± Ù†ÙØ³Ùƒ ÙÙŠ Ø§Ù„Ø­Ø§Ø¬Ø© Ø§Ù„Ù„ÙŠ Ø¨ØªØ­Ø¨Ù‡Ø§ ÙˆØ£Ù†Ø§ Ù…Ø¹Ø§Ùƒ ğŸ¤ğŸ¥°', sender: 'bot', id: 'bot3' },
            { text: 'Ø§Ø¨Ø¹ØªÙ„ÙŠ Ø£Ø­Ù„Ø§Ù…Ùƒ ÙˆØ£Ù‡Ø¯Ø§ÙÙƒ ÙˆÙ…ØªÙ‚Ù„Ù‚Ø´ Ø£Ù†Ø§ Ù‡Ù‚Ù Ø¬Ù†Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„ ğŸ˜‰ğŸ«µ', sender: 'bot', id: 'bot4' }
        ];

        // ------------------ Ù…Ù†Ø·Ù‚ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù„Ù… ÙŠØªØºÙŠØ±) ------------------
        function loadChatHistory() {
            const history = localStorage.getItem(CHAT_STORAGE_KEY);
            let savedHistory = history ? JSON.parse(history) : [];
            // Ø¥Ø¶Ø§ÙØ© ID Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ID Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ø­Ø°Ù
            savedHistory.forEach(msg => {
                if (!msg.id) msg.id = generateUniqueId();
            });
            return savedHistory;
        }

        function saveChatHistory(history) {
            localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(history));
        }
        
        // ------------------ Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù„Ù… ÙŠØªØºÙŠØ±) ------------------
        function showMessages(chatType, clickedElement) {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('messages').style.display = 'block';
            currentChat = chatType;
            
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';
            const chatTitle = document.getElementById('chat-title');
            const inputContainer = document.getElementById('message-input-container');
            
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            clickedElement.classList.add('active');

            if (chatType === 'important') {
                chatTitle.textContent = 'ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù‡Ø§Ù…Ø©';
                inputContainer.style.display = 'none';
                addMessage('Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±Ù‰ Ø£Ù† Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù…ÙÙŠØ¯Ø©ØŒ ÙÙƒÙ„ Ù…Ø§ Ø¹Ù„ÙŠÙƒ Ù‡Ùˆ Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ Ø¹Ù„Ù‰ Ø£ÙˆØ³Ø¹ Ù†Ø·Ø§Ù‚!', 'bot', true, null, null, null, 'imp1');
                addMessage('Ø±ÙˆØ§Ø¨Ø· Ù…Ù†ØµØ§Øª Ø­Ù„ØªÙ‡Ø§Ù„Ùƒ:<br>ğŸŒ Web: <a href="https://halthalk.vercel.app" target="_blank" style="color:#1D7AFC;">halthalk.vercel.app</a><br>ğŸ“± Telegram: <a href="https://t.me/Halthalkbot" target="_blank" style="color:#1D7AFC;">@Halthalkbot</a>', 'bot', true, null, null, null, 'imp2');
            } else if (chatType === 'owner') {
                chatTitle.textContent = 'Ù…Ø§Ù„Ùƒ Ù…Ù†ØµØ© Ø­Ù„ØªÙ‡Ø§Ù„Ùƒ';
                inputContainer.style.display = 'flex';
                
                const savedMessages = loadChatHistory();
                let fullHistory = [...initialOwnerMessages];
                
                // Ø¯Ù…Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø®Ø²Ù†Ø©
                const initialIds = initialOwnerMessages.map(msg => msg.id);
                const uniqueSavedMessages = savedMessages.filter(msg => !initialIds.includes(msg.id));

                fullHistory = fullHistory.concat(uniqueSavedMessages);
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                fullHistory.forEach(msg => addMessage(msg.text, msg.sender, false, msg.attachmentType, msg.attachmentInfo, msg.attachmentUrl, msg.id));
            }
            
            messageList.scrollTop = messageList.scrollHeight;
            updateSendButton(); 
        }

        // â­ï¸ Ø¯Ø§Ù„Ø© addMessage Ø§Ù„Ù…ÙØ¹Ø¯Ù„Ø© Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµÙˆØªÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        function addMessage(text, sender = 'user', autoScroll = true, attachmentType = null, attachmentInfo = null, attachmentUrl = null, msgId = null) {
            if (!msgId) msgId = generateUniqueId(); 

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender === 'bot' ? 'other' : ''}`;
            messageDiv.setAttribute('data-id', msgId); 
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const cleanText = DOMPurify.sanitize(text, {ALLOWED_TAGS: ['a', 'br', 'p', 'span'], ALLOWED_ATTR: ['href', 'target', 'style', 'class']});
            
            // 1. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„Ù…Ø±ÙÙ‚
            if (attachmentType && attachmentUrl) {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'attachment-preview';
                
                if (attachmentType === 'image') {
                    previewDiv.innerHTML = `<img src="${attachmentUrl}" alt="ØµÙˆØ±Ø© Ù…ÙØ±Ø³Ù„Ø©">`;
                } else if (attachmentType === 'audio') {
                    // â­ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØµÙ…ÙŠÙ… Voice Note Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    const duration = attachmentInfo.duration || '00:00';
                    const audioClass = sender === 'bot' ? 'voice-note other' : 'voice-note';
                    
                    previewDiv.innerHTML = `
                        <audio src="${attachmentUrl}" data-duration="${duration}" style="display:none;"></audio>
                        <div class="${audioClass}">
                            <button class="voice-play-btn" data-state="play"><i class="fas fa-play"></i></button>
                            <div class="voice-timeline">
                                <div class="voice-progress"></div>
                            </div>
                            <span class="voice-duration">${duration}</span>
                        </div>
                    `;
                    // 2. Ø±Ø¨Ø· Ø§Ù„Ù€ DOM Ù…Ø¹ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    setTimeout(() => {
                        const voiceNoteDiv = previewDiv.querySelector('.voice-note');
                        if(voiceNoteDiv) {
                           const audio = previewDiv.querySelector('audio');
                           const playBtn = previewDiv.querySelector('.voice-play-btn');
                           const progressDiv = previewDiv.querySelector('.voice-progress');
                           
                           setupVoiceNoteControls(audio, playBtn, progressDiv);
                        }
                    }, 0);
                    
                } else if (attachmentType === 'file' && attachmentInfo) {
                    const fileName = attachmentInfo.name || 'Ù…Ù„Ù';
                    const fileSize = attachmentInfo.size || '';

                    previewDiv.innerHTML = `
                        <div class="file-card">
                            <span class="file-card-icon"><i class="fas fa-file"></i></span>
                            <div class="file-card-info">
                                <div class="file-card-name">${fileName}</div>
                                <div class="file-card-size">Ø§Ù„Ø­Ø¬Ù…: ${fileSize}</div>
                            </div>
                            <button class="preview-file-btn" onclick="window.open('${attachmentUrl}', '_blank')">Ù…Ø¹Ø§ÙŠÙ†Ø©/ØªÙ†Ø²ÙŠÙ„</button>
                        </div>
                    `;
                }
                
                contentDiv.appendChild(previewDiv);

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ/Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø£Ø³ÙÙ„ Ø§Ù„Ù…Ø±ÙÙ‚
                if (cleanText) {
                     const textNode = document.createElement('p');
                     textNode.innerHTML = cleanText;
                     contentDiv.appendChild(textNode);
                }
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø±ÙÙ‚ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙƒØ§Ù„Ù…Ø¹ØªØ§Ø¯
                contentDiv.innerHTML = cleanText;
            }

            // 2. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ²Ø± Ø§Ù„Ø­Ø°Ù
            if (sender === 'user') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-content-wrapper'; 
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'flex-end';

                const deleteBtn = document.createElement('button');
                // â­ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¥Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© FA 
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>'; 
                deleteBtn.className = 'delete-btn';
                deleteBtn.title = 'Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©';
                deleteBtn.onclick = () => deleteMessage(msgId);
                
                // ÙÙŠ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…ØŒ Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙŠÙƒÙˆÙ† Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ù†Ø¶Ø¹Ù‡ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                wrapper.appendChild(deleteBtn); 
                wrapper.appendChild(contentDiv);
                
                messageDiv.appendChild(wrapper);

            } else {
                messageDiv.appendChild(contentDiv);
            }
            
            document.getElementById('message-list').appendChild(messageDiv);
            
            if (autoScroll) {
                const messageList = document.getElementById('message-list');
                setTimeout(() => {
                    messageList.scrollTop = messageList.scrollHeight;
                }, 100);
            }
        }
        
        // â­ï¸ Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµÙˆØªÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        function setupVoiceNoteControls(audio, playBtn, progressDiv) {
            
            // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            const updateProgress = () => {
                const percent = (audio.currentTime / audio.duration) * 100;
                progressDiv.style.width = `${percent}%`;
            };
            
            // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª
            const togglePlayPauseIcon = (isPlaying) => {
                playBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
                playBtn.setAttribute('data-state', isPlaying ? 'pause' : 'play');
            };
            
            // Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
            playBtn.addEventListener('click', () => {
                if (audio.paused || audio.ended) {
                    audio.play();
                    togglePlayPauseIcon(true);
                } else {
                    audio.pause();
                    togglePlayPauseIcon(false);
                }
            });

            // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª
            audio.addEventListener('play', () => {
                togglePlayPauseIcon(true);
            });
            audio.addEventListener('pause', () => {
                togglePlayPauseIcon(false);
            });
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', () => {
                audio.currentTime = 0; // Ø¥Ø±Ø¬Ø§Ø¹ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                togglePlayPauseIcon(false);
                progressDiv.style.width = '0%'; // Ù…Ø³Ø­ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            });
            
            // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©)
            const durationSpan = playBtn.parentElement.querySelector('.voice-duration');
            audio.addEventListener('loadedmetadata', () => {
                const durationSeconds = Math.floor(audio.duration);
                const minutes = String(Math.floor(durationSeconds / 60)).padStart(2, '0');
                const seconds = String(durationSeconds % 60).padStart(2, '0');
                if (durationSpan.textContent === '00:00') {
                    durationSpan.textContent = `${minutes}:${seconds}`;
                }
            });
        }


        // â­ï¸ Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù„Ù… ØªØªØºÙŠØ±)
        function deleteMessage(msgId) {
            const messageElement = document.querySelector(`.message[data-id="${msgId}"]`);
            if (!messageElement) return;

            // 1. Ø­Ø°Ù Ù…Ù† DOM
            messageElement.remove();

            // 2. ØªØ­Ø¯ÙŠØ« Local Storage
            let history = loadChatHistory();
            const initialLength = history.length;
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø«Ø§Ø¨ØªØ©
            const isBotMessage = initialOwnerMessages.some(msg => msg.id === msgId);
            if (isBotMessage) return; 

            history = history.filter(msg => msg.id !== msgId);
            
            if (history.length !== initialLength) {
                saveChatHistory(history);

                // 3. ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
                const combinedHistory = [...initialOwnerMessages, ...history.filter(msg => !initialOwnerMessages.map(i => i.id).includes(msg.id))];
                const lastMessage = combinedHistory.pop();
                document.getElementById('owner-last-message').textContent = lastMessage ? lastMessage.text : initialOwnerMessages[initialOwnerMessages.length - 1].text;
            }
        }

        // ------------------ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ ------------------
        
        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
        function sendConfirmationMessage() {
            const confirmationText = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ³ÙŠØªÙ… ØªÙÙ‚Ø¯Ù‡Ø§ Ù‚Ø±ÙŠØ¨Ø§Ù‹. Ù…Ù„Ø­ÙˆØ¸Ø©: Ù†Ø­Ù† Ù†ØªÙÙ‚Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆÙ„Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø±Ø¯ Ø¨Ø³Ø¨Ø¨ Ø³Ø±Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ø¥Ù„ÙŠÙ†Ø§ ğŸ™‚â¤ï¸â€ğŸ©¹';
            // Ù†Ø³ØªØ®Ø¯Ù… setTimeout Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ø¯ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            setTimeout(() => {
                addMessage(confirmationText, 'bot', true);
            }, 200);
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || currentChat !== 'owner') return;
            
            const newMsgId = generateUniqueId();
            addMessage(message, 'user', true, null, null, null, newMsgId);
            
            const history = loadChatHistory();
            history.push({ text: message, sender: 'user', id: newMsgId }); 
            saveChatHistory(history);
            
            document.getElementById('owner-last-message').textContent = message;
            
            input.value = '';
            input.rows = 1;
            updateSendButton();
            // â­ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
            sendTextToTelegram(message); 
            // â­ï¸ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
            sendConfirmationMessage();
        }
        
        // ------------------ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Attachment Handling) ------------------

        function toggleAttachmentMenu() {
            if (currentChat !== 'owner') return;
            const menu = document.getElementById('attachment-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function handleAttachment(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            toggleAttachmentMenu(); 

            currentAttachment = {
                file: file,
                type: type,
                dataUrl: null,
                caption: ''
            };
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentAttachment.dataUrl = e.target.result;
                showPreviewModal();
            };
            
            if (type === 'image' || type === 'audio') {
                // Ù‚Ø±Ø§Ø¡Ø© ÙƒÙ€ Data URL Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„ÙŠ
                reader.readAsDataURL(file);
            } else {
                // Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ØŒ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù€ Data URL Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ù†ØµÙŠ
                showPreviewModal();
            }
            
            event.target.value = '';
        }

        function showPreviewModal() {
            const modal = document.getElementById('preview-modal');
            const placeholder = document.getElementById('preview-placeholder');
            
            placeholder.innerHTML = '';
            document.getElementById('preview-caption').value = '';
            
            const file = currentAttachment.file;

            if (currentAttachment.type === 'image') {
                placeholder.innerHTML = `<img id="preview-media" src="${currentAttachment.dataUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©">`;
            } else if (currentAttachment.type === 'file') {
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                placeholder.innerHTML = `<p style="color:var(--telegram-blue); text-align:center; font-size:18px;">ğŸ“ ${file.name}</p><p style="text-align:center; font-size:14px; color:var(--text-secondary);">Ø§Ù„Ø­Ø¬Ù…: ${fileSizeMB} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</p>`;
            } else if (currentAttachment.type === 'audio') {
                 placeholder.innerHTML = `<audio id="preview-media" controls src="${currentAttachment.dataUrl}"></audio><p style="text-align:center; margin-top:10px; color:var(--text-light);">ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ (${document.getElementById('recording-timer').textContent})</p>`;
            }
            
            modal.style.display = 'flex';
        }

        function closePreviewModal() {
            document.getElementById('preview-modal').style.display = 'none';
            currentAttachment = null;
        }
        
        function sendAttachment() {
            if (!currentAttachment) return;

            const caption = document.getElementById('preview-caption').value.trim();
            const attachmentType = currentAttachment.type;
            const attachmentFile = currentAttachment.file;
            const attachmentUrl = currentAttachment.dataUrl; // Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„ÙŠ
            
            let attachmentInfo = {};
            let displayMessage = caption;

            if (attachmentType === 'image' || attachmentType === 'file') {
                const fileSizeMB = (attachmentFile.size / (1024 * 1024)).toFixed(2);
                attachmentInfo = {
                    name: attachmentFile.name,
                    size: `${fileSizeMB} MB`
                };
                displayMessage = caption || `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${attachmentType} (${attachmentInfo.name})`;
                
            } else if (attachmentType === 'audio') {
                // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¯Ø© Ù…Ù† Ø§Ù„Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø±Ø³Ù„ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                const duration = document.getElementById('recording-indicator').style.display === 'flex' ? document.getElementById('recording-timer').textContent : '00:00';
                attachmentInfo = { duration: duration };
                displayMessage = caption || `ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ: ${duration}`;
            }

            const newMsgId = generateUniqueId();
            
            // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø© (Ù…Ø¹ ID Ùˆ URL Ù„Ù„Ø¹Ø±Ø¶)
            addMessage(caption, 'user', true, attachmentType, attachmentInfo, attachmentUrl, newMsgId); 
            
            // 2. ØªØ­Ø¯ÙŠØ« LocalStorage (Ù„Ø­ÙØ¸ URL Ù„Ù„Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„)
            const history = loadChatHistory();
            history.push({ 
                text: caption, 
                sender: 'user', 
                attachmentType: attachmentType, 
                attachmentInfo: attachmentInfo,
                attachmentUrl: attachmentUrl, 
                id: newMsgId 
            });
            saveChatHistory(history);
            
            // 3. ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
            document.getElementById('owner-last-message').textContent = displayMessage;
            
            // 4. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Telegram 
            sendFileToTelegram(attachmentFile, caption);
            // â­ï¸ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
            sendConfirmationMessage();


            closePreviewModal();
        }

        // ------------------ Ù…Ù†Ø·Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª ------------------
        
        function updateTimer() {
            const currentTime = Date.now();
            const elapsed = Math.floor((currentTime - recorderStartTime) / 1000);
            const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
            const seconds = String(elapsed % 60).padStart(2, '0');
            document.getElementById('recording-timer').textContent = `${minutes}:${seconds}`;
        }

        async function startRecording() {
            if (currentChat !== 'owner') return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    clearInterval(recordingInterval);
                    const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                    
                    // ÙŠØªÙ… Ø¬Ù„Ø¨ Ù…Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‡Ù†Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                    const duration = document.getElementById('recording-timer').textContent;

                    currentAttachment = {
                        file: audioBlob,
                        type: 'audio',
                        dataUrl: URL.createObjectURL(audioBlob),
                        caption: '',
                        // Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø© ÙƒÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø±ÙÙ‚Ø© Ù„ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ sendAttachment
                        info: { duration: duration } 
                    };
                    showPreviewModal();
                };

                mediaRecorder.start();
                
                document.getElementById('recording-indicator').style.display = 'flex';
                document.getElementById('message-input-container').style.display = 'none';

                recorderStartTime = Date.now();
                document.getElementById('recording-timer').textContent = '00:00';
                recordingInterval = setInterval(updateTimer, 1000);

            } catch (err) {
                alert('ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.');
                console.error('Recording error:', err);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop()); 
                document.getElementById('recording-indicator').style.display = 'none';
                document.getElementById('message-input-container').style.display = 'flex'; 
            }
        }
        
        // ------------------ ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù„Ù… ØªØªØºÙŠØ±) ------------------

        // â­ï¸ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
        async function sendTextToTelegram(text) {
            try {
                const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                const payload = {
                    chat_id: CHAT_ID,
                    text: text
                };
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    console.error('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª.');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©:', error);
            }
        }

        // â­ï¸ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
        async function sendFileToTelegram(file, caption) {
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);

            let apiEndpoint;
            if (file.type.startsWith('image/')) {
                apiEndpoint = 'sendPhoto';
                formData.append('photo', file);
            } else if (file.type.startsWith('audio/')) {
                apiEndpoint = 'sendAudio';
                formData.append('audio', file);
            } else if (file.type.startsWith('video/')) {
                 apiEndpoint = 'sendVideo';
                 formData.append('video', file);
            } else {
                apiEndpoint = 'sendDocument';
                formData.append('document', file);
            }
            
            if (caption) {
                formData.append('caption', caption);
            }

            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/${apiEndpoint}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    console.error('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª.');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©:', error);
            }
        }


        function updateSendButton() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const voiceBtn = document.getElementById('voice-btn');
            const attachmentBtn = document.getElementById('attachment-btn');
            
            const hasText = input.value.trim().length > 0;
            const isOwnerChat = currentChat === 'owner';

            attachmentBtn.style.display = isOwnerChat ? 'block' : 'none';

            if (hasText) {
                sendBtn.style.display = 'flex';
                voiceBtn.style.display = 'none';
            } else {
                sendBtn.style.display = 'none';
                voiceBtn.style.display = 'block';
            }

            sendBtn.disabled = !(hasText && isOwnerChat);
        }

        function handleKeyPress(event) {
            setTimeout(updateSendButton, 0); 
            
            setTimeout(() => {
                const input = event.target;
                const lines = input.value.split('\n').length;
                input.rows = Math.min(6, Math.max(1, lines)); 
            }, 0);

            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // â­ï¸ Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ (backToList) Ù…ÙØ¹Ø¯Ù„Ø© Ù„Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function backToList() {
            if (currentChat === 'owner') {
                // 1. ØªØµÙÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ ÙÙ‚Ø· Ø¨Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª (Ø§Ù„ØªÙŠ Ù„ÙŠØ³ Ù„Ù‡Ø§ Ø²Ø± Ø­Ø°Ù)
                let history = loadChatHistory();
                const botMessages = history.filter(msg => msg.sender === 'bot');
                saveChatHistory(botMessages);
                
                // 2. ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© 
                const lastBotMessage = botMessages.pop() || initialOwnerMessages[initialOwnerMessages.length - 1];
                document.getElementById('owner-last-message').textContent = lastBotMessage.text;
            }

            document.getElementById('messages').style.display = 'none';
            document.getElementById('popup').style.display = 'block';
            
            const input = document.getElementById('message-input');
            input.value = '';
            input.rows = 1; 
            updateSendButton();
            document.getElementById('attachment-menu').style.display = 'none';
        }

        // ğŸ’¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø³ÙŠØ·Ø© Ù„ØªÙ†Ø¸ÙŠÙ HTML
        const DOMPurify = {
            sanitize: (html, options) => {
                let tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                if (options && options.ALLOWED_TAGS) {
                    const allElements = tempDiv.querySelectorAll('*');
                    allElements.forEach(el => {
                        if (!options.ALLOWED_TAGS.includes(el.tagName.toLowerCase())) {
                            el.remove();
                        }
                        Array.from(el.attributes).forEach(attr => {
                            if (!options.ALLOWED_ATTR.includes(attr.name.toLowerCase())) {
                                el.removeAttribute(attr.name);
                            }
                        });
                    });
                }
                
                return tempDiv.innerHTML;
            }
        };

        // ğŸ’¡ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('message-input').addEventListener('input', updateSendButton);
            
            const history = loadChatHistory();
            
            const allBotMessages = [...initialOwnerMessages, ...history.filter(msg => msg.sender === 'bot')];
            const lastMsg = allBotMessages.length > 0 ? allBotMessages.pop().text : initialOwnerMessages[initialOwnerMessages.length - 1].text;

            document.getElementById('owner-last-message').innerHTML = DOMPurify.sanitize(lastMsg);
            
            backToList(); 
        });
    </script>
</body>
</html>
